#!/usr/bin/env perl

use 5.012;
use strict;
use warnings;
use Transposome;
use Transposome::PairFinder;
use Transposome::Cluster;
use Transposome::SeqStore;
use Transposome::Annotation;

my $trans_obj = Transposome->new_with_options();

my $config = $trans_obj->get_config;

my $blast_res = Transposome::PairFinder->new( file              => $config->{blast_file},  
					      dir               => $config->{output_directory},
					      in_memory         => $config->{in_memory},
					      percent_identity  => $config->{percent_identity},
					      fraction_coverage => $config->{fraction_coverage} );

my ($idx_file, $int_file, $hs_file) = $blast_res->parse_blast;

my $cluster = Transposome::Cluster->new( file            => $int_file,
					 dir             => $config->{output_directory},
					 merge_threshold => $config->{merge_threshold},
					 cluster_size    => $config->{cluster_size} );

my $comm = $cluster->louvain_method;
my $cluster_file = $cluster->make_clusters($comm, $idx_file);
my ($read_pairs, $vertex, $uf) = $cluster->find_pairs($cluster_file, $config->{report_file});
my $memstore = Transposome::SeqStore->new( file => $config->{sequence_file}, in_memory => $config->{in_memory} );
my ($seqs, $seqct) = $memstore->store_seq;
my ($cls_dir_path, $cls_with_merges_path, $cls_tot) = $cluster->merge_clusters($vertex, $seqs, 
                                                                               $read_pairs, $config->{report_file}, $uf);
my $annotation = Transposome::Annotation->new( database  => $config->{repeat_database},
					       rb_json   => $config->{repeat_json_file},
					       dir       => $config->{output_directory},
					       file      => $config->{report_file} );

my ($anno_rp_path, $anno_sum_rep_path, $total_readct,                                                                           
    $rep_frac, $blasts, $superfams) = $annotation->annotate_clusters($cls_dir_path, $seqct, $cls_tot);

$annotation->clusters_annotation_to_summary($anno_rp_path, $anno_sum_rep_path, $total_readct,
                                            $seqct, $rep_frac, $blasts, $superfams, $config->{report_file});
